@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery antiforgery
@{
    ViewData["Title"] = "Modo de Emergência";
    Layout = "~/Views/Shared/_UsuarioLayout.cshtml";
    var requestToken = antiforgery.GetAndStoreTokens(Context).RequestToken;
}

<div class="user-content-wrapper">
    <div class="emergency-panel-pro">
        <h1 class="panel-title">
            <i class="bi bi-exclamation-octagon-fill" style="font-size: 2rem; color: var(--cor-perigo);"></i>
            Painel de Emergência
        </h1>
        <p class="panel-subtitle">
            Olá, <span class="fw-bold">@ViewBag.NomeUsuario</span>! Use os botões abaixo para notificar o administrador sobre sua situação em tempo real.
        </p>

        <div class="emergency-actions">
            <h5>Qual é o seu status?</h5>
            <button class="btn-emergency danger" onclick="ativarPerigo()">
                <i class="bi bi-broadcast-pin"></i> ATIVAR MODO PERIGO
            </button>
            <button class="btn-emergency safe" onclick="desativarPerigo()">
                <i class="bi bi-shield-check"></i> ESTOU SEGURO
            </button>
        </div>

        <div id="dangerStatusAlert" class="status-alert status-alert-info">
            <i class="bi bi-info-circle-fill"></i>
            <span>Seu status de segurança ainda não foi definido. Clique em um dos botões acima.</span>
        </div>
        <div id="locationStatusAlert" class="status-alert status-alert-info">
            <i class="bi bi-geo-alt-fill"></i>
            <span>Iniciando monitoramento de localização...</span>
        </div>

        <iframe id="mapaIframe" class="map-frame" src="" allow="geolocation" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
</div>

@section Scripts {
    <script>
        const requestToken = "@requestToken";
        const dangerStatusAlert = document.getElementById('dangerStatusAlert');
        const locationStatusAlert = document.getElementById('locationStatusAlert');
        const mapaIframe = document.getElementById('mapaIframe');

     
        async function ativarPerigo() {
            if (!confirm("Tem certeza que deseja ATIVAR o modo de perigo? Sua localização será compartilhada.")) return;

            navigator.geolocation.getCurrentPosition(async (position) => {
                const locationData = {
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude
                };

                try {
                    const response = await fetch('/Denuncia/AtivarModoPerigo', {
                        method: 'POST',
                        headers: {
                            'RequestVerificationToken': requestToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(locationData)
                    });
                    const result = await response.json();
                    if (result.success) {
                        updateDangerStatus(true, "MODO PERIGO ATIVADO! O administrador foi notificado.");
                    } else {
                        alert("Erro ao ativar modo perigo: " + result.message);
                    }
                } catch (error) {
                    console.error("Falha na chamada para AtivarModoPerigo:", error);
                }
            },
            (error) => {
                alert("Não foi possível obter sua localização para ativar o modo perigo. Verifique as permissões do navegador.");
                console.error("Erro ao obter localização: ", error);
            });
        }

        async function desativarPerigo() {
             try {
                const response = await fetch('/Denuncia/DesativarModoPerigo', {
                    method: 'POST',
                    headers: { 'RequestVerificationToken': requestToken }
                });
                const result = await response.json();
                if (result.success) {
                    updateDangerStatus(false, "Você está seguro. O administrador foi notificado.");
                } else {
                    alert("Erro ao desativar modo perigo: " + result.message);
                }
            } catch (error) {
                console.error("Falha na chamada para DesativarModoPerigo:", error);
            }
        }

        function updateDangerStatus(isDanger, message) {
            dangerStatusAlert.className = isDanger ? 'status-alert status-alert-danger' : 'status-alert status-alert-success';
            const icon = isDanger ? '<i class="bi bi-exclamation-triangle-fill"></i>' : '<i class="bi bi-check-circle-fill"></i>';
            dangerStatusAlert.innerHTML = `${icon} <span>${message}</span>`;
        }

        function updateLocationStatus(statusType, message) {
            locationStatusAlert.className = `status-alert status-alert-${statusType}`;
            let icon = '<i class="bi bi-geo-alt-fill"></i>';
            if (statusType === 'danger') icon = '<i class="bi bi-exclamation-circle-fill"></i>';
            if (statusType === 'info') icon = '<i class="bi bi-info-circle-fill"></i>';
            locationStatusAlert.innerHTML = `${icon} <span>${message}</span>`;
        }

        let watchId = null;
        function watchLocation() {
            if (navigator.geolocation) {
                const options = { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 };
                watchId = navigator.geolocation.watchPosition(geolocationSuccess, geolocationError, options);
            } else {
                updateLocationStatus('danger', "Seu navegador não suporta Geolocalização.");
            }
        }

        function geolocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const timestamp = new Date(position.timestamp).toLocaleTimeString();
            mapaIframe.src = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
            updateLocationStatus('success', `Localização atualizada com sucesso às ${timestamp}.`);
        }

        function geolocationError(err) {
            let msg = 'Erro desconhecido ao obter localização.';
            if (err.code === err.PERMISSION_DENIED) msg = "Permissão de localização negada. Habilite nas configurações do seu navegador.";
            if (err.code === err.POSITION_UNAVAILABLE) msg = "Informação de localização indisponível no momento.";
            if (err.code === err.TIMEOUT) msg = "Tempo limite excedido para obter a localização.";
            updateLocationStatus('danger', msg);
        }

        window.onbeforeunload = function() { if (watchId !== null) navigator.geolocation.clearWatch(watchId); };
        document.addEventListener('DOMContentLoaded', watchLocation);
    </script>
}
```